---
title: "Estimating propensity scores with logistic regression"
output: html_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library("devtools")
devtools::install_github("alanbrookhart/NAMCS")
library(NAMCS)
library(tableone)
library(survey)
library(knitr)
library(DT)
library(geepack)
```


## Viewing the data
```{r}
ns %>% datatable()
```


## Create a simple Table 1
```{r}
CreateTableOne(data = ns, strata = "cox2_initiation", test = FALSE, smd = TRUE) 
```


## Fit a propensity score model and display parameter estimates
```{r}
ps_model = glm(cox2_initiation ~ age + race + arthritis + aspirin_use + ppi_use + anti_coagulant_use, data = ns, family = binomial)

summary(ps_model)
```



## Add the propensity score to the data set
```{r}
ns$ps <- predict(ps_model, type = "response")
```


## Plot the distribution of PS overall
```{r}
ggplot(data = ns, aes(x = ps)) +
  geom_histogram(
  aes(y = ..density..),
  color = "white",
  alpha = 0.5,
  binwidth = 0.01
  #position = position_dodge(width = 0.01/2)
  ) + theme_bw() +
  guides(colour = FALSE,
         linetype = FALSE)

```


## Plot the distribution of PS, by treatment group
```{r}
ggplot(data = ns, aes(x = ps, group = cox2_initiation, fill = cox2_initiation)) +
  geom_histogram(
    aes(y = ..density..),
    color = "white",
    alpha = 0.5,
    binwidth = 0.01,
    position = position_dodge(width = 0.01/2)) + theme_bw() +
  guides(colour = FALSE,
         linetype = FALSE)

```


## Fit a logistic regression of the outcome
```{r}
glm_unweighted = glm(incident_pud ~ cox2_initiation, data = ns, family = binomial)
summary(glm_unweighted)
```


## Compute IPTW 
```{r}
ns$iptw = I(ns[["cox2_initiation"]] == "Yes") / ns$ps + (1 - I(ns[["cox2_initiation"]] == "Yes")) / (1 - ns$ps)
```


## Summarize weights by treatment groups
```{r}
summary(ns$iptw[ns$cox2_initiation == "Yes"],)
summary(ns$iptw[ns$cox2_initiation == "No"],)
```


## Create weighted table 1
```{r}
ns.svy = svydesign(ids = ~ 1, data = ns,
                   weights = ~ iptw)

svyCreateTableOne(vars = c("arthritis", "aspirin_use",  "ppi_use",  "anti_coagulant_use"),
                  factorVars = c("arthritis", "aspirin_use",  "ppi_use",  "anti_coagulant_use"),
                  strata = "cox2_initiation",
                  data = ns.svy, test = FALSE)
```


## Estimate IPTW regression of outcome on treatment
```{r}
glm_weighted = glm(incident_pud ~ cox2_initiation, data = ns, family = binomial,
                     weights = iptw)
summary(glm_weighted)
```


## Compute SMRW
```{r}
ns$smrw= I(ns[["cox2_initiation"]] == "Yes") +
  (1 - I(ns[["cox2_initiation"]] == "Yes")) * ns$ps / (1-ns$ps)
```


## Summarize weights by treatment groups
```{r}
summary(ns$smrw[ns$cox2_initiation == "Yes"],)
summary(ns$smrw[ns$cox2_initiation == "No"],)
```


## Compute weighted table 1
```{r}
ns.svy = svydesign(ids = ~ 1, data = ns,
                   weights = ~ smrw)

svyCreateTableOne(vars = c("arthritis", "aspirin_use",  "ppi_use",  "anti_coagulant_use"),
                  factorVars = c("arthritis", "aspirin_use",  "ppi_use",  "anti_coagulant_use"),
                  strata = "cox2_initiation",
                  data = ns.svy, test = FALSE)
```


## Estimate SMRW regression of outcome on treatment
```{r}
glm_weighted = glm(incident_pud ~ cox2_initiation, data = ns, family = binomial,
                   weights = smrw)
summary(glm_weighted)
```


